<template lang="jade">
.card.mb-3.message(v-if="!messageData.hidden_at")
  alerts(ref="alerts")
  b-dropdown(:id="'message-actions-dropdown-'+messageData.id", class="message-actions-dropdown", size="sm", text="Actions", :right="true")
    b-dropdown-item(:href="'/transactions/'+messageData.tx_id", v-if="messageData.tx_id") View Transaction
    b-dropdown-item(:href="'/messages/'+messageData.id") Details
    b-dropdown-item(:href="'/messages/'+messageData.id+'/edit'", v-if="messageOwnedBycurrentAccount()") Edit
    b-dropdown-item(href="javascript:;", v-if="messageOwnedBycurrentAccount()", @click="hideMessage") {{ $t('hide') }}
  .card-header
    .row
      .col-2
        img.img-fluid.img-thumbnail(:src='messageData.account.avatar.thumb', :alt='messageData.sender')
      .col-10
        h5.mt-1.mb-0.text-truncate.username 
          a.text-dark(:href="'/u/'+messageData.account.username") {{ messageData.account.username_or_address }}
        small
          a.text-dark(:href="'/messages/'+messageData.id"){{ moment(messageData.timestamp).fromNow() }}
  .card-body
    .mt-2
      .mt-2
      message-body(:message="message")

      div(v-if="messageData.reply_to")
        mini-message(:message="messageData.reply_to")
          | {{ $t('reply_from')}} + {{ messageData.reply_to.account.username_or_address }}

      div(v-if="messageData.repost")
        mini-message(:message="messageData.repost")
          | {{ $t('repost_from') }} {{ messageData.repost.account.username_or_address }}

      div(v-if="messageData.tip")
        mini-message(:message="messageData.tip.to_message")
          | {{ $t('tipping') }} + ${{ tipAmount(messageData.tip.value) }} to {{ messageData.tip.to_message.account.username_or_address }}


      div.mt-2.onebox-container(v-if="messageData.onebox", v-html="messageData.onebox")
    .space
  .card-footer

    small.text-muted
      i.fa.fa-spin.fa-spinner.mr-1(v-if="messageData.is_loading")
      span(v-if="!messageData.is_loading")

        i.fa.mr-1(title="Reply", v-bind:class="{pointer: (currentAccount && !messageData.is_replied), 'fa-comment-o': !messageData.is_replied, 'fa-comment': messageData.is_replied}", v-on:click="reply", :id="'reply-message-'+messageData.id")
        span(v-if="messageData.reply_count > 0")
          {{ messageData.reply_count }}

        i.ml-3.fa.mr-1(title="Favorite", v-bind:class="{pointer: (currentAccount && !messageData.is_favorited), 'fa-star-o': !messageData.is_favorited, 'fa-star': messageData.is_favorited}", v-on:click="toggleFavorite", :id="'favorite-message-'+messageData.id")
        span(v-if="messageData.favorites_count > 0")
          {{ messageData.favorites_count }}

        span(v-if="message.json_schema === 'micro'")
          i.ml-3.mr-1.fa.fa-refresh(title="Repost", v-bind:class="{pointer: (currentAccount && !messageData.is_reposted)}", v-on:click="repost", :id="'repost-message-'+messageData.id")
          span(v-if="messageData.repost_count > 0")
            {{ messageData.repost_count }}

        a.text-muted.ml-3.mr-1(title="Tip", v-bind:class="{pointer: (currentAccount && !messageData.is_tipped)}", v-on:click="tip", :id="'tip-message-'+messageData.id")
          ${{ tipAmount(messageData.tips_sum) }}
      
      b-tooltip(:target="'reply-message-'+messageData.id", title="Reply")
      b-tooltip(:target="'favorite-message-'+messageData.id", title="Favorite")
      span(v-if="message.json_schema === 'micro'")
        b-tooltip(:target="'repost-message-'+messageData.id", title="Repost")
      b-tooltip(:target="'tip-message-'+messageData.id", :title="messageData.is_tipped ? 'Tips' : 'Send a Tip'")

      div(v-if="currentAccount")
        b-modal(:ref="'reply-modal-'+messageData.id", title="Reply", @ok="submitReply", ok-title="Reply")
          p
            small
              strong {{ $t('original_message') }}:
            br
            {{ messageData.body }}
          .mt-2
          textarea.form-control(placeholder="Type your response", v-model="replyBody")
          p.small
            span.text-muted  {{ $t('max_character') }}
            span(v-if="replyBody.length > 0", v-bind:class="{ 'text-muted': (replyBody.length <= 280), 'text-danger': (replyBody.length > 280) }")
              |  {{ $t('current') }} {{ replyBody.length }} {{ replyBody.length === 0 ? 'character' : 'characters' }}.

        b-modal(ref="confirmHideModal", title="Are you sure?", @ok="submitHide", ok-title="Hide")
          p
            | {{ $t('bloblo_noti1')}}
            |  {{ $t('bloblo_noti2')}}

          p {{ $t('confirmation_hide')}}
      
      send-tip-modal(ref="sendTip",
                      :account="messageData.account",
                      :message="messageData"
                      @sent="handleTipResponse")

</template>

<script>
import moment from 'moment';
import batchEvents from '../libs/batch-events';
import MiniMessage from './mini-message.vue';

export default {
  props: {
    message: {
      type: Object
    },
    compact: {
      type: Boolean,
      default: true
    }
  },
  components: {
    'mini-message': MiniMessage,
  },
  data() {
    return {
      moment: moment,
      replyBody: '',
      currentAccount: window.currentAccount,
      messageData: this.message,
    };
  },
  methods: {
    userLink(username) {
      return `/u/${username}`;
    },
    async toggleFavorite() {
      const { messageData } = this;
      if (!this.currentAccount || messageData.is_favorited) {
        return true;
      }
      const url = `/favorites?message_id=${messageData.id}`;

      messageData.is_loading = true;

      try {
        await $.ajax({
          url: url,
          method: 'POST',
          dataType: 'json'
        });
        batchEvents.triggerNewBatch();
        this.alertSuccess(this.$t('favorite_create'));
        messageData.is_favorited = true;
        messageData.favorites_count += 1;
        messageData.is_loading = false;
      } catch (error) {
        messageData.is_loading = false;
        this.alertError(this.$t('error_upload_favorite_ipfs'));
      }
    },
    async repost() {
      const { messageData } = this;
      if (!this.currentAccount || messageData.is_reposted) {
        return true;
      }  
      
      messageData.is_loading = true;

      try {
        const repost = await $.ajax({
          url: `/messages/${messageData.id}/repost`,
          method: 'POST',
          dataType: 'json'
        }); 
        batchEvents.triggerNewBatch();
        messageData.is_reposted = true;
        messageData.repost_count += 1;
        messageData.is_loading = false;

        this.$emit('repost', repost);
        this.alertSuccess(this.$t('repost_create'));
      } catch (error) {
        console.log(error);
        messageData.is_loading = false;
        this.alertError(this.$t('error_upload_repost_ipfs'));
      }
    },
    async reply() {
      const { messageData } = this;
      if (!this.currentAccount || messageData.is_replied) {
        return true;
      }
      
      const modal = this.$refs['reply-modal-'+messageData.id];
      modal.show();
    },
    async submitReply(evt) {
      const { messageData } = this;
      if (!this.currentAccount || messageData.is_replied || (this.replyBody.length > 280)) {
        evt.preventDefault();
        return true;
      }
      messageData.is_loading = true;

      try {
        const reply = await $.ajax({
          url: `messages/${messageData.id}/reply`,
          method: 'POST',
          dataType: 'json',
          data: {
            body: this.replyBody,
            json_schema: 'micro'
          }
        });
        console.log(reply);
        batchEvents.triggerNewBatch();
        this.alertSuccess(this.$t('reply_create'));
        messageData.is_replied = true;
        messageData.reply_count += 1;
        this.$emit('reply', reply);
      } catch (error) {
        console.log(error);
        this.alertError(this.$t('error_upload_reply_ipfs'));
      }
      messageData.is_loading = false;
    },
    messageOwnedBycurrentAccount() {
      return this.currentAccount && (this.currentAccount.id === this.messageData.account.id);
    },
    tip() {
      if (!this.currentAccount || this.messageData.is_tipped || this.messageOwnedBycurrentAccount()) {
        return true;
      }
      this.$refs.sendTip.show();
    },
    handleTipResponse(response) {
      console.log(response);
      if (response.tip && response.tip.message_tips_sum) {
        this.messageData.tips = response.tip.message_tips_sum;
        this.messageData.is_tipped = true;
      }
    },
    hideMessage() {
      this.$refs.confirmHideModal.show();
    },
    async submitHide() {
      if (!this.messageOwnedBycurrentAccount()) {
        return true;
      }
      const { messageData } = this;
      messageData.is_loading = true;
      try {
        const message = await $.ajax({
          url: `/messages/${this.messageData.id}`,
          dataType: 'json',
          method: 'delete'
        });
        this.messageData = message;
        batchEvents.triggerNewBatch();
        this.alertSuccess(this.$t('hide_message'));
      } catch (error) {
        console.log(error);
        this.alertError(this.$t('error_hide_message'));
      }
      messageData.is_loading = false;
    },
    tipAmount(value) {
      return (value * ETH_USD).toFixed(2);
    }
  }
};
</script>

<style lang="sass" scoped>
.message-actions-dropdown
  display: none
  z-index: 100;

.card:hover
  .message-actions-dropdown
    display: block;
    position: absolute;
    right: 10px;
    top: 5px;

.onebox-container
  max-width: 100%
  iframe
    max-width: 100%
</style>
